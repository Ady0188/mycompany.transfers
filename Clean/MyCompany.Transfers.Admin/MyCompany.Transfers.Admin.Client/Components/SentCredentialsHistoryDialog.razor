@using MudBlazor
@using MyCompany.Transfers.Admin.Client.Models
@using MyCompany.Transfers.Admin.Client.Services
@inject IAgentsApiService Api

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">История отправок — @(AgentName ?? AgentId)</MudText>
    </TitleContent>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else if (_list.Count == 0)
        {
            <MudText>Писем с данными терминалов не отправлялось.</MudText>
        }
        else
        {
            <MudTable T="SentCredentialsEmailItemDto" Items="_list" Hover="true" Dense="true" Striped="true" Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>Дата и время (UTC)</MudTh>
                    <MudTh>Терминал</MudTh>
                    <MudTh>Кому</MudTh>
                    <MudTh>Тема</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Дата">@context.SentAtUtc.ToString("yyyy-MM-dd HH:mm")</MudTd>
                    <MudTd DataLabel="Терминал">@context.TerminalId</MudTd>
                    <MudTd DataLabel="Кому">@context.ToEmail</MudTd>
                    <MudTd DataLabel="Тема">@(string.IsNullOrEmpty(context.Subject) ? "—" : context.Subject!.Length > 50 ? context.Subject[..50] + "…" : context.Subject)</MudTd>
                </RowTemplate>
            </MudTable>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Закрыть</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public string AgentId { get; set; } = "";
    [Parameter] public string? AgentName { get; set; }

    private List<SentCredentialsEmailItemDto> _list = new();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await Api.GetSentCredentialsHistoryAsync(AgentId);
            _list = result?.ToList() ?? new List<SentCredentialsEmailItemDto>();
        }
        catch
        {
            _list = new List<SentCredentialsEmailItemDto>();
        }
        finally
        {
            _loading = false;
        }
    }

    private void Close() => MudDialog.Close();
}
