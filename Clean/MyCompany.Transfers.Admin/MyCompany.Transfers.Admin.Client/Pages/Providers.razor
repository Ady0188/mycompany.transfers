@page "/providers"
@using MyCompany.Transfers.Admin.Client.Models
@using MyCompany.Transfers.Admin.Client.Services
@inject IProvidersApiService Api
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Провайдеры — Админ-панель</PageTitle>

<MudStack Spacing="3">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h4" GutterBottom="false">Провайдеры</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenCreate">
            Добавить
        </MudButton>
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }

    <MudCard Elevation="2">
        <MudTable Items="@_list" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true" Striped="true" FixedHeader="true" Height="400px">
            <HeaderContent>
                <MudTh>Id</MudTh>
                <MudTh>Счёт</MudTh>
                <MudTh>Название</MudTh>
                <MudTh>Base URL</MudTh>
                <MudTh>Вкл.</MudTh>
                <MudTh>Комиссия ‰</MudTh>
                <MudTh Style="width: 120px;">Действия</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Id">@context.Id</MudTd>
                <MudTd DataLabel="Счёт">@context.Account</MudTd>
                <MudTd DataLabel="Название">@context.Name</MudTd>
                <MudTd DataLabel="Base URL">@(context.BaseUrl?.Length > 30 ? context.BaseUrl[..30] + "…" : context.BaseUrl)</MudTd>
                <MudTd DataLabel="Вкл.">@(context.IsEnabled ? "Да" : "Нет")</MudTd>
                <MudTd DataLabel="Комиссия">@context.FeePermille</MudTd>
                <MudTd DataLabel="Действия">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => OpenEdit(context))" title="Изменить" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => ConfirmDelete(context))" title="Удалить" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudCard>
</MudStack>

@code {
    private List<ProviderAdminDto> _list = new();
    private bool _loading;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _loading = true;
        StateHasChanged();
        try
        {
            _list = await Api.GetAllAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Ошибка загрузки: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task OpenCreate()
    {
        var dto = new ProviderAdminDto { Id = "", Account = "", Name = "", BaseUrl = "", TimeoutSeconds = 30, AuthType = 0, SettingsJson = "{}", IsEnabled = true, FeePermille = 0 };
        var parameters = new DialogParameters { ["Model"] = dto, ["IsCreate"] = true };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ProviderEditDialog>("Новый провайдер", parameters, options);
        var result = await dialog.Result;
        if (result != null && !result.Canceled)
            await LoadAsync();
    }

    private async Task OpenEdit(ProviderAdminDto item)
    {
        var copy = new ProviderAdminDto
        {
            Id = item.Id, Account = item.Account, Name = item.Name ?? "", BaseUrl = item.BaseUrl ?? "",
            TimeoutSeconds = item.TimeoutSeconds, AuthType = item.AuthType, SettingsJson = item.SettingsJson ?? "{}",
            IsEnabled = item.IsEnabled, IsOnline = item.IsOnline, FeePermille = item.FeePermille
        };
        var parameters = new DialogParameters { ["Model"] = copy, ["IsCreate"] = false };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ProviderEditDialog>("Изменить провайдера", parameters, options);
        var result = await dialog.Result;
        if (result != null && !result.Canceled)
            await LoadAsync();
    }

    private async Task ConfirmDelete(ProviderAdminDto item)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Удалить провайдера «{item.Id}»?",
            ["ButtonText"] = "Удалить",
            ["Color"] = Color.Error
        };
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Подтверждение", parameters, options);
        var result = await dialog.Result;
        if (result != null && !result.Canceled)
        {
            var (success, error) = await Api.DeleteAsync(item.Id);
            if (success)
            {
                Snackbar.Add("Провайдер удалён.", Severity.Success);
                await LoadAsync();
            }
            else
                Snackbar.Add(error ?? "Ошибка удаления", Severity.Error);
        }
    }
}
